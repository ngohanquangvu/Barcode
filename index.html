warnings.filterwarnings("ignore", category = DeprecationWarning, module = "pyzbar")


logger = logging.getLogger('cv2')

if os.path.exists("./Video") == False:
    os.mkdir("./Video")

name_folder = f"{datetime.datetime.now().day}-{datetime.datetime.now().month}-{datetime.datetime.now().year}"
if os.path.exists(f"./Video/{name_folder}") == False:
    os.mkdir(f"./Video/{name_folder}")

# # Khởi tạo một biến để lưu trữ mã vạch đã quét
# barcode = None

# # Khởi tạo một biến để lưu trữ trạng thái ghi hình
# recording = False

# # Khởi tạo một biến để lưu trữ thời gian bắt đầu ghi hình
# start_time = None

# # Khởi tạo một biến để lưu trữ thời gian bắt đầu quay thêm
# extra_time = None

# # Khởi tạo một đối tượng VideoWriter để lưu video
# out = None

# run = True

def Get_Status(bot_message):
    bot_token = '6044809598:AAFfdYSI3M2oVvOUu2UVF1_3M79uzM1aVT0' # Nhập mã thông báo API của bot của bạn ở đây
    bot_chatID = '@tenicatool' # Nhập chat_id của bạn ở đây
    send_text = 'https://api.telegram.org/bot' + bot_token + '/sendMessage?chat_id=' + bot_chatID + '&parse_mode=Markdown&text=' + bot_message
    response = requests.get(send_text)

def run(webcam_index):
    name_file = f"{datetime.datetime.now().hour}-{datetime.datetime.now().minute}-{datetime.datetime.now().second}"
    try:
        Get_Status(str(datetime.datetime.now()))
    except: pass

    # Tạo một biến chia sẻ để lưu trữ mã vạch được quét bởi bất kỳ webcam nào
    shared_barcode = None

    # Tạo một khóa chia sẻ để đồng bộ hóa việc truy cập vào biến mã vạch chia sẻ
    shared_lock = threading.Lock()
    # Tạo một hàm để quét mã vạch và ghi hình từ một webcam
    def scan_and_record():
        # Tạo một đối tượng VideoCapture để lấy hình ảnh từ webcam
        cap = cv2.VideoCapture(webcam_index)

        # Khởi tạo một biến để lưu trữ mã vạch đã quét
        barcode = None

        # Khởi tạo một biến để lưu trữ trạng thái ghi hình
        recording = False

        # Khởi tạo một biến để lưu trữ thời gian bắt đầu ghi hình
        start_time = None

        # Khởi tạo một biến để lưu trữ thời gian bắt đầu quay thêm
        extra_time = None

        # Khởi tạo một đối tượng VideoWriter để lưu video
        out = None

        run = True

        # Lặp lại cho đến khi người dùng nhấn phím q
        while run:
            # Đọc một khung hình từ webcam
            ret, frame = cap.read()

            # Nếu không đọc được khung hình, thoát khỏi vòng lặp
            if not ret:
                break

            # Giải mã các mã vạch từ khung hình
            decoded_objects = pyzbar.decode(frame)

            # Duyệt qua các mã vạch đã giải mã
            for obj in decoded_objects:
                # Lấy dữ liệu từ mã vạch
                data = obj.data.decode('utf-8')

                # Nếu chưa có mã vạch nào được lưu trữ, lưu trữ mã vạch hiện tại và bắt đầu ghi hình
                if barcode is None:
                    barcode = data
                    recording = True
                    start_time = time.time()
                    print(f"Bắt đầu ghi hình với mã vạch {barcode}")
                    # Tạo một đối tượng VideoWriter với các thông số phù hợp
                    out = cv2.VideoWriter(f'./Video/{name_folder}/{name_file}_Cam{webcam_index}_{barcode}.mp4', cv2.VideoWriter_fourcc(*'mp4v'), 60.0, (640, 480))

                # Nếu có mã vạch được lưu trữ và trùng với mã vạch hiện tại, kiểm tra xem đã ghi hình được trên 5 giây hay chưa
                elif barcode == data:
                    elapsed_time = time.time() - start_time
                    # Nếu đã ghi hình được trên 5 giây, bắt đầu tính thời gian quay thêm nếu chưa có
                    if elapsed_time >= 3 and extra_time is None:
                        extra_time = time.time()
                        print(f"Bắt đầu quay thêm 3 giây với mã vạch {data}")

            # Nếu đang ghi hình, ghi khung hình hiện tại vào video
            if recording:
                out.write(frame)

            # Nếu có thời gian quay thêm, kiểm tra xem đã quá 5 giây hay chưa
            if extra_time is not None:
                elapsed_time = time.time() - extra_time
                # Nếu đã quá 5 giây, dừng ghi hình và xóa các biến đã lưu
                if elapsed_time >= 3:
                    recording = False
                    run = False
                    barcode = None
                    start_time = None
                    extra_time = None
                    print(f"Dừng ghi hình sau 3 giây")
                    # Giải phóng đối tượng VideoWriter
                    out.release()
                    out = None

            # Hiển thị khung hình trên cửa sổ
            cv2.imshow(f'Webcam {webcam_index}', frame)

            # Kiểm tra xem người dùng có nhấn phím q hay không
            key = cv2.waitKey(1)


        # Giải phóng các đối tượng VideoCapture và VideoWriter
        cap.release()
        if out is not None:
            out.release()

        # Đóng tất cả các cửa sổ
        cv2.destroyAllWindows()
    scan_and_record()

print("CONNECTING TO WEBCAM...")

num_webcam = 0

while True:
    cap = cv2.VideoCapture(num_webcam)
    ret, frame = cap.read()

    if not ret:
        break

    num_webcam+=1
    cap.release()

checking = True

def choose_webcam():
        while True:
            a = int(input("CHỌN WEBCAM SỐ: "))

            if a>=0 and a<=(num_webcam-1):
                break
            else:
                os.system("cls")
        return a

id_cam = 0

os.system("cls")
while True:
    banner=f"""
 ██████  ██████       █████  ███    ██ ██████      ██████  ███████  ██████  ██████  ██████  ██████  
██    ██ ██   ██     ██   ██ ████   ██ ██   ██     ██   ██ ██      ██      ██    ██ ██   ██ ██   ██ 
██    ██ ██████      ███████ ██ ██  ██ ██   ██     ██████  █████   ██      ██    ██ ██████  ██   ██ 
██ ▄▄ ██ ██   ██     ██   ██ ██  ██ ██ ██   ██     ██   ██ ██      ██      ██    ██ ██   ██ ██   ██ 
 ██████  ██   ██     ██   ██ ██   ████ ██████      ██   ██ ███████  ██████  ██████  ██   ██ ██████  
    ▀▀             
                                                                                        By Nhqvu

                                        [{num_webcam} WEBCAMS ĐANG KẾT NỐI]

                                        1. BẮT ĐẦU
                                        2. CHỌN WEBCAM (WEBCAM HIỆN TẠI: {id_cam})
                                        3. THOÁT
"""
    print(banner)
    choice = input("                                        NHẬP LỰA CHỌN: ")
    if choice == "1":
        break
    elif choice == "2":
        id_cam = choose_webcam()
        os.system("cls")
    elif choice == "3":
        exit()
    else:
        os.system("cls")

os.system("cls")

if choice == "1":
    while True:
        run(id_cam)
        os.system("cls")
        print("TIẾP TỤC QUAY SAU 5 GIÂY")
        time.sleep(5)
        os.system("cls")
